var crypto = require('crypto')
var fs = require('fs')
var path = require('path')
var mime = require('mime')
var readDir = require('fs-readdir-recursive')
var debug = require('debug')('express-static-cache')

module.exports = function staticCache(dir, options, files) {
  if (typeof dir !== 'string')
    throw TypeError('Dir must be a defined string')

  options = options || {}
  files = files || options.files || {}

  readDir(dir).forEach(function (name) {
    var pathname = '/' + name
    var obj = files[pathname] = {}
    var filename = obj.path = path.join(dir, name)
    var stats = fs.statSync(filename)
    var buffer = fs.readFileSync(filename)

    obj.maxAge = options.maxAge || 0
    obj.type = obj.mime = mime.lookup(pathname)
    obj.charset = mime.charsets.lookup(obj.mime)
    if (obj.charset)
      obj.type += '; charset=' + obj.charset.toLowerCase()
    obj.mtime = new Date(stats.mtime).toUTCString()
    obj.length = stats.size
    obj.etag = '"' + crypto
      .createHash('md5')
      .update(buffer)
      .digest('hex') + '"'

    if (options.buffer)
      obj.buffer = buffer

    buffer = null
  })

  if (options.alias) {
    Object.keys(options.alias).forEach(function (key) {
      var value = options.alias[key]

      if (files[value]) {
        files[key] = files[value]
        debug('aliasing ' + value + ' as ' + key)
      }
    })
  }

  return function staticCache(req, res, next) {
      var file = files[req.path]
      if (!file)
        return next()

      switch (req.method) {
        case 'HEAD':
        case 'GET':
          res.setHeader('Content-Type', file.type)
          res.setHeader('Cache-Control', 'public, max-age=' + file.maxAge)
          res.setHeader('Content-Length', file.length)
          res.setHeader('Last-Modified', file.mtime)
          res.setHeader('ETag', file.etag)
          if (req.fresh) {
            res.statusCode = 304
            res.end()
          } else if (req.method === 'GET') {
            if (file.buffer)
              res.end(file.buffer)
            else
              fs.createReadStream(file.path).pipe(res)
          } else {
            res.end()
          }
          return
        case 'OPTIONS':
          res.statusCode = 204
          res.setHeader('Allow', 'HEAD,GET,OPTIONS')
          res.end()
          return
        default:
          res.statusCode = 405
          res.set('Allow', 'HEAD,GET,OPTIONS')
          res.end()
          return
      }
  }
}